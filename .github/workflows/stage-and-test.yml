name: Stage assets & test

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            VDR/web-client/package-lock.json

      - name: Install Python deps (best effort)
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f VDR/requirements.txt ]; then pip install -r VDR/requirements.txt; fi
          pip install pytest

      - name: Set PYTHONPATH for tests
        run: |
          echo "PYTHONPATH=VDR:VDR/chart-tiler:${PYTHONPATH}" >> $GITHUB_ENV

      - name: Install Web deps (best effort)
        run: |
          if [ -f VDR/web-client/package.json ]; then npm ci --prefix VDR/web-client; fi

      - name: Stage runtime assets (OpenCPN + BAUV)
        env:
          # If your OpenCPN assets live elsewhere, override here:
          # S57_ASSETS_DIR: /path/to/data/s57data
        run: |
          bash VDR/scripts/stage_assets_all.sh --force
          test -f VDR/staged_assets_manifest.json
          jq '.count' VDR/staged_assets_manifest.json || true
          ls -la VDR/server-styling/dist/assets/s52

      - name: Python tests
        run: |
          pytest -q VDR

      - name: Web tests
        run: |
          if [ -f VDR/web-client/package.json ]; then npm test --prefix VDR/web-client --silent; fi
