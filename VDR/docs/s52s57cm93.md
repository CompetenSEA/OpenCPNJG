# CM93/S-57 → Web (S-52 Day) Pipeline

**Design goals:** upstream S-52 assets as-is; vector-first; optional raster; no binaries in PRs; `sc` end-to-end.

## 1. Assets (lock-based)
- Lock format, required files, manifest, reproducibility, local-src mode.

## 2. Sprite & Style
- Sprite: atlas PNG served as-is; JSON generated; **prefix** support.
- Style: Tier-1 layers plus seamark points, caution lines and area stubs; QUAPOS; safety overlay; SOUNDG tokens; hazard layer (prefix-safe).
- `build_style_json.py --emit-name <name> --palette day|dusk|night --auto-cover` synthesises layers for every lookup.

## 3. Palettes
- `build_style_json.py --palette day|dusk|night` selects colour tables.
- Palette tokens (e.g. `SNDG1/2`) thread through style generation and tests.

## 4. Local assets & repo hygiene
- Commit the lock file and generated JSON only; binaries stay out of Git.
- Fetch upstream S-52 assets locally:

```
python VDR/server-styling/sync_opencpn_assets.py \
  --lock VDR/server-styling/opencpn-assets.lock \
  --dest VDR/server-styling/dist/assets/s52 --force
```
- Local assets from `data/s57data/`:

```
python VDR/server-styling/tools/stage_local_assets.py \
  --repo-data data/s57data \
  --dest VDR/server-styling/dist/assets/s52 --force
```
- Build all palettes for development:

```
python VDR/server-styling/tools/build_all_styles.py \
  --chartsymbols VDR/server-styling/dist/assets/s52/chartsymbols.xml \
  --tiles-url "/tiles/cm93/{z}/{x}/{y}?fmt=mvt&safety={safety}&shallow={shallow}&deep={deep}" \
  --source-name cm93 --source-layer features \
  --sprite-base "/sprites/s52-day" --sprite-prefix "s52-" \
  --glyphs "/glyphs/{fontstack}/{range}.pbf" \
  --auto-cover \
  --emit-name "OpenCPN S-52 {palette} (auto-cover)"
```

## 5. Pre-classification (server-side CSP proxies)
- DEPARE → `isShallow`, `depthBand`; DEPCNT → `role`; SOUNDG → `isShallow`.
- UDW hazards → `hazardIcon` (+ now `hazardOffX/hazardOffY`).

## 6. Tile server
- Endpoints, cache key (`fmt:safety,shallow,deep:z/x/y`), headers, metrics.

## 7. ContourConfig
- Schema: `{safety, shallow, deep, hazardBuffer?}`; defaults `10/5/30`.
- `/tiles/...` accept `safety`, `shallow`, `deep` (fallback to `sc` for compat).
- `GET /config/contours` returns server defaults.

## 8. CI & Validation
- Node validator flow; artifacts; tests.

## 9. Configuration & Running Locally
- Commands, Makefile snippets.

## 10. Coverage (auto-generated)
<!-- BEGIN:S52_COVERAGE -->
| metric | value |
| --- | ---: |
| total lookups | 231 |
| presence coverage | 100.0% |
| portrayal coverage | 78.4% |
| missing | 0 |

### Missing OBJL
(none)

### Portrayal gaps
- ######
- AIRARE
- ANNOTA
- ASLXIS
- BOYWTW
- CANBNK
- CBLOHD
- CBLSUB
- CHNWIR
- CURENT
- DEPARE
- FNCLNE
- FSHFAC
- ICEARE
- LAKSHR
- LIGHTS
- LNDELV
- MARCUL
- M_QUAL
- NAVLNE
- OILBAR
- OWNSHP
- PIPOHD
- POSLIN
- RADLNE

### Symbols seen
- marker-15
<!-- END:S52_COVERAGE -->

## 11. S-57 attribute mapping
- `VALSOU`, `VAL`, `DRVAL1`, `DRVAL2`, `QUAPOS`, `WATLEV`, `ORIENT`, `hazardIcon`, `hazardOffX`, `hazardOffY`.

## 12. Known limits & roadmap
- Presence coverage must remain **100%**; portrayal parity will improve over time.
- Night/Dusk later; full pattern fills TBD; raster parity optional.
