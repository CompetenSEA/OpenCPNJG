# CM93/S-57 → Web (S-52 Day) Pipeline

**Design goals:** upstream S-52 assets as-is; vector-first; optional raster; no binaries in PRs; `sc` end-to-end.

## 1. Assets (lock-based)
- Lock format, required files, manifest, reproducibility, local-src mode.

## 2. Sprite & Style
- Sprite: atlas PNG served as-is; JSON generated; **prefix** support.
- Style: Tier-1 layers plus seamark points, caution lines and area stubs; QUAPOS; safety overlay; SOUNDG tokens; hazard layer (prefix-safe).
- `build_style_json.py --emit-name <name> --palette day|dusk|night` for palette-aware styles.

## 3. Palettes
- `build_style_json.py --palette day|dusk|night` selects colour tables.
- Palette tokens (e.g. `SNDG1/2`) thread through style generation and tests.

## 4. Local assets & repo hygiene
- Commit the lock file and generated JSON only; binaries stay out of Git.
- Fetch upstream S-52 assets locally:

```
python VDR/server-styling/sync_opencpn_assets.py \
  --lock VDR/server-styling/opencpn-assets.lock \
  --dest VDR/server-styling/dist/assets/s52 --force
```
- Build all palettes for development:

```
python VDR/server-styling/tools/build_all_styles.py \
  --chartsymbols VDR/server-styling/dist/assets/s52/chartsymbols.xml \
  --tiles-url "/tiles/cm93/{z}/{x}/{y}?fmt=mvt&safety={safety}&shallow={shallow}&deep={deep}" \
  --source-name cm93 --source-layer features \
  --sprite-base "/sprites/s52-day" --sprite-prefix "s52-" \
  --glyphs "/glyphs/{fontstack}/{range}.pbf"
```

## 5. Pre-classification (server-side CSP proxies)
- DEPARE → `isShallow`, `depthBand`; DEPCNT → `role`; SOUNDG → `isShallow`.
- UDW hazards → `hazardIcon` (+ now `hazardOffX/hazardOffY`).

## 6. Tile server
- Endpoints, cache key (`fmt:safety,shallow,deep:z/x/y`), headers, metrics.

## 7. ContourConfig
- Schema: `{safety, shallow, deep, hazardBuffer?}`; defaults `10/5/30`.
- `/tiles/...` accept `safety`, `shallow`, `deep` (fallback to `sc` for compat).
- `GET /config/contours` returns server defaults.

## 8. CI & Validation
- Node validator flow; artifacts; tests.

## 9. Configuration & Running Locally
- Commands, Makefile snippets.

## 10. Coverage (auto-generated)
<!-- BEGIN:S52_COVERAGE -->
| metric | value |
| --- | ---: |
| total lookups | 231 |
| covered by style | 10 |
| missing | 221 |

### Delta
covered change: +5
- ACHARE
- ADMARE
- BCNCAR
- BOYCAR
- SEAARE

### Missing OBJL
- ######
- $AREAS
- $CSYMB
- $LINES
- $TEXTS
- ACHBRT
- ACHPNT
- AIRARE
- ANNOTA
- ARCSLN
- ASLXIS
- BCNISD
- BCNLAT
- BCNSAW
- BCNSPP
- BCNWTW
- BERTHS
- BOYINB
- BOYISD
- BOYLAT

### Symbols seen
(none)
<!-- END:S52_COVERAGE -->

## 11. Known limits & roadmap
- Night/Dusk later; full pattern fills TBD; raster parity optional.
