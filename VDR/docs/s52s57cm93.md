# CM93/S-57 → Web (S-52 Day) Pipeline

**Design goals:** upstream S-52 assets as-is; vector-first; optional raster; no binaries in PRs; `sc` end-to-end.

## 1. Assets (lock-based)
- Lock format, required files, manifest, reproducibility, local-src mode.

## 2. Sprite & Style
- Sprite: atlas PNG served as-is; JSON generated; **prefix** support.
- Style: Tier-1 layers plus seamark points, caution lines and area stubs; QUAPOS; safety overlay; SOUNDG tokens; hazard layer (prefix-safe).
 - Style: Tier-1 layers plus seamark points, caution lines and area stubs; QUAPOS; safety overlay; SOUNDG tokens; hazard layer (prefix-safe).
 - SOUNDG and seamark name labels scale with zoom and hide at low zooms.
 - `build_style_json.py --emit-name <name> --palette day|dusk|night --auto-cover` synthesises layers for every lookup.
   Presence coverage is the fraction of lookups with any style layer;
   portrayal coverage tracks layers with semantically appropriate paint.
 - Wave-3 heuristics: LIGHTS gain composite labels and sector legs/arcs; navaids rotate via `ORIENT` and expose optional names; underwater hazards pick WATLEV-aware icons with dashed QUAPOS; SCAMIN can map to `tippecanoe.minzoom`. Presence stays 100% and the S-57 catalogue is ≥99% handled.

## 3. Palettes
- `build_style_json.py --palette day|dusk|night` selects colour tables.
- Palette tokens (e.g. `SNDG1/2`) thread through style generation and tests.
- `tools/build_all_styles.py` now emits day/dusk/night styles and tags `metadata.maplibre:s52.palette`.

## 4. Local assets & repo hygiene
- Commit the lock file and generated JSON only; binaries stay out of Git.
- Fetch upstream S-52 assets locally:

```
python VDR/server-styling/sync_opencpn_assets.py \
  --lock VDR/server-styling/opencpn-assets.lock \
  --dest VDR/server-styling/dist/assets/s52 --force
```
- Local assets from `data/s57data/`:

```
python VDR/server-styling/tools/stage_local_assets.py \
  --repo-data data/s57data \
  --dest VDR/server-styling/dist/assets/s52 --force
```
- Build all palettes for development:

```
python VDR/server-styling/tools/build_all_styles.py \
  --chartsymbols VDR/server-styling/dist/assets/s52/chartsymbols.xml \
  --tiles-url "/tiles/cm93/{z}/{x}/{y}?fmt=mvt&safety={safety}&shallow={shallow}&deep={deep}" \
  --source-name cm93 --source-layer features \
  --sprite-base "/sprites/s52-day" --sprite-prefix "s52-" \
  --glyphs "/glyphs/{fontstack}/{range}.pbf" \
  --auto-cover \
  --emit-name "OpenCPN S-52 {palette}"
```

## 5. Pre-classification (server-side CSP proxies)
- DEPARE → `isShallow`, `depthBand`; DEPCNT → `role`; SOUNDG → `isShallow`.
- UDW hazards → `hazardIcon` (+ now `hazardOffX/hazardOffY`, `hazardBuffer`).
- BCN*/BOY* navaids yield `navaidIcon` with optional `ORIENT` rotation and `OBJNAM` labels.
- Cable/pipeline areas expose `linePattern` hints when line style metadata is present.
- The contour nearest to the safety depth is flagged as `role="safety"` when an exact match is missing.

## 6. Tile server
- Endpoints, cache key (`fmt:safety,shallow,deep:z/x/y`), headers, metrics.
- Optional `MBTILES_PATH` streams real MVTs; otherwise a deterministic stub feeds tests.
- `GET /config/datasource` reports the active backend and MBTiles metadata.
- `/style/s52.{day|dusk|night}.json` expose palette swaps; `fmt=png-mvp` or `RASTER_MVP=1` renders a minimal DEPARE/DEPCNT raster via Pillow.

## 7. ContourConfig
- Schema: `{safety, shallow, deep, hazardBuffer?}`; defaults `10/5/30`.
- `/tiles/...` accept `safety`, `shallow`, `deep` (fallback to `sc` for compat).
- `GET /config/contours` returns server defaults.

## 8. CI & Validation
- Node validator flow; artifacts; tests.

## 9. Configuration & Running Locally
- Commands, Makefile snippets.

## 10. Coverage (auto-generated)
<!-- BEGIN:S52_COVERAGE -->
| metric | value |
| --- | ---: |
| total lookups | 231 |
| presence coverage | 100.0% |
| portrayal coverage | 42.9% |
| area portrayal | 28.5% |
| line portrayal | 2.5% |
| point portrayal | 37.7% |
| areas portrayal | 41.3% |
| depths portrayal | 100.0% |
| hazards portrayal | 0.0% |
| lights portrayal | 0.0% |
| navaids portrayal | 100.0% |
| missing | 0 |

### Delta
covered change: +0

### Missing OBJL
(none)

### Portrayal gaps
- ######
- $TEXTS
- ACHARE
- ACHBRT
- ADMARE
- ANNOTA
- ARCSLN
- ASLXIS
- BERTHS
- BOYWTW
- BRIDGE
- BUNSTA
- CANBNK
- CBLARE
- CBLOHD
- CBLSUB
- CHKPNT
- CHNWIR
- CONVYR
- CONZNE
- COSARE
- CTNARE
- CTSARE
- CURENT
- CUSZNE

### Symbols seen
- marker-15

### S-57 catalogue
| metric | value |
| --- | ---: |
| total classes | 251 |
| have S-52 lookup | 185 |
| handled by styles | 248 |
| ignored | 3 |
| missing | 0 |

#### Missing S-57 classes
(none)
<!-- END:S52_COVERAGE -->

## 11. S-57 Catalogue
Some S-57 object classes lack direct S-52 lookups. Neutral stub layers are
generated so every class remains visible; see the table above for current
catalogue status.

## 12. S-57 attribute mapping
- `OBJL`, `DRVAL1`, `DRVAL2`, `VALDCO`, `VALSOU`, `QUAPOS`,
  `WATLEV`, `CATWRK`, `CATOBS`, `SCAMIN`.

`SCAMIN` is preserved verbatim; when encoding with `--respect-scamin` it is
clamped and mapped to `tippecanoe.minzoom` for future runtime filtering.

## 13. Known limits & roadmap
- Presence coverage must remain **100%**; portrayal parity will improve over time.
- Night/Dusk later; full pattern fills TBD; raster parity optional.
